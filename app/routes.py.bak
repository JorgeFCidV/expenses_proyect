from flask import Blueprint, render_template, redirect, url_for, flash, request, send_from_directory, current_app
from flask_login import login_required, current_user, logout_user, login_user
from app.models import User, Company, Expense
from app.forms import (
    LoginForm, CreateCompanyForm, InviteUserForm,
    UploadExpenseForm, EditExpenseForm, ResetPasswordRequestForm, ResetPasswordForm
)
from app import db
from app.utils import save_picture, ocr_process
from app.email import send_reset_password_mail, send_invite_mail
import os

routes = Blueprint('routes', __name__)

# LOGIN / LOGOUT
@routes.route('/login', methods=['GET', 'POST'])
def login():
    if current_user.is_authenticated:
        return redirect(url_for('routes.index'))
    form = LoginForm()
    if form.validate_on_submit():
        user = User.query.filter_by(email=form.email.data.lower()).first()
        if user and user.check_password(form.password.data) and user.is_active:
            login_user(user, remember=form.remember.data)
            flash('¡Bienvenido!', 'success')
            return redirect(url_for('routes.index'))
        flash('Email o contraseña incorrectos', 'danger')
    return render_template('login.html', form=form)

@routes.route('/logout')
@login_required
def logout():
    logout_user()
    return redirect(url_for('routes.login'))

# DASHBOARD SEGÚN ROL
@routes.route('/')
@routes.route('/index')
@login_required
def index():
    if current_user.role == 'master':
        companies = Company.query.all()
        users = User.query.order_by(User.role.desc(), User.email).all()
        return render_template('master_dashboard.html', companies=companies, users=users)
    elif current_user.role == 'admin':
        company_ids = [c.id for c in current_user.companies]
        expenses = Expense.query.filter(Expense.company_id.in_(company_ids)).order_by(Expense.id.desc()).all()
        return render_template('admin_dashboard.html', expenses=expenses, companies=current_user.companies)
    else:
        expenses = Expense.query.filter_by(user_id=current_user.id).order_by(Expense.id.desc()).all()
        return render_template('user_dashboard.html', expenses=expenses)

# MASTER: crear empresa
@routes.route('/create-company', methods=['GET', 'POST'])
@login_required
def create_company():
    if current_user.role != 'master':
        flash('Solo el master puede crear empresas', 'danger')
        return redirect(url_for('routes.index'))
    form = CreateCompanyForm()
    if form.validate_on_submit():
        if Company.query.filter_by(vat=form.vat.data).first():
            flash('NIF ya existe', 'danger')
        else:
            c = Company(name=form.name.data, vat=form.vat.data)
            db.session.add(c)
            db.session.commit()
            flash('Empresa creada', 'success')
            return redirect(url_for('routes.index'))
    return render_template('create_company.html', form=form)

# INVITAR USUARIOS
@routes.route('/invite/<string:role>', methods=['GET', 'POST'])
@login_required
def invite_user(role):
    if current_user.role == 'master':
        allowed = ['admin', 'user']
        companies = Company.query.all()
    elif current_user.role == 'admin':
        allowed = ['user']
        companies = current_user.companies
    else:
        flash('Sin permiso', 'danger')
        return redirect(url_for('routes.index'))

    if role not in allowed:
        flash('Rol no permitido', 'danger')
        return redirect(url_for('routes.index'))

    form = InviteUserForm()
    form.company_id.choices = [(c.id, f"{c.name} ({c.vat})") for c in companies]

    if form.validate_on_submit():
        if User.query.filter_by(email=form.email.data.lower()).first():
            flash('Email ya registrado', 'warning')
        else:
            user = User(email=form.email.data.lower(), name=form.name.data, role=role, is_active=True)
            user.set_password(form.temp_password.data)
            db.session.add(user)
            db.session.flush()
            company = Company.query.get(form.company_id.data)
            user.companies.append(company)
            db.session.commit()
            send_invite_mail(user, company, form.temp_password.data)
            flash(f'{role.capitalize()} creado correctamente', 'success')
            return redirect(url_for('routes.index'))
    return render_template('invite_user.html', form=form, role=role)

# SUBIDA DE TICKETS
@routes.route('/upload', methods=['GET', 'POST'])
@login_required
def upload():
    if not current_user.companies:
        flash('No tienes empresas asignadas', 'warning')
        return redirect(url_for('routes.index'))
    form = UploadExpenseForm()
    form.company_id.choices = [(c.id, c.name) for c in current_user.companies]
    if form.validate_on_submit():
        filename = save_picture(form.image.data)
        full_path = os.path.join(current_app.root_path, 'static', 'uploads', filename)
        text = ocr_process(full_path)
        company_id = form.company_id.data or current_user.companies[0].id
        e = Expense(
            image_path=filename,
            extracted_text=text,
            user_id=current_user.id,
            company_id=company_id
        )
        db.session.add(e)
        db.session.commit()
        flash('Ticket subido. Completa los datos', 'success')
        return redirect(url_for('routes.edit_expense', expense_id=e.id))
    return render_template('upload.html', form=form)

# EDITAR GASTO
@routes.route('/expense/<int:expense_id>/edit', methods=['GET', 'POST'])
@login_required
def edit_expense(expense_id):
    expense = Expense.query.get_or_404(expense_id)
    allowed = [c.id for c in current_user.companies] if current_user.role != 'master' else None
    if current_user.role != 'master' and expense.company_id not in allowed:
        flash('Acceso denegado', 'danger')
        return redirect(url_for('routes.index'))
    form = EditExpenseForm(obj=expense)
    if form.validate_on_submit():
        expense.nif_iva = form.nif_iva.data
        expense.company_name = form.company_name.data
        expense.analytic_account = form.analytic_account.data
        expense.expense_nature = form.expense_nature.data
        expense.amount = form.amount.data
        expense.date = form.date.data
        db.session.commit()
        flash('Gasto guardado correctamente', 'success')
        return redirect(url_for('routes.index'))
    return render_template('expense_edit.html', form=form, expense=expense)

# ELIMINAR GASTO
@routes.route("/expense/<int:expense_id>/delete", methods=["POST"])
@login_required
def delete_expense(expense_id):
    expense = Expense.query.get_or_404(expense_id)
    
    if current_user.role not in ["master", "admin"] and expense.user_id != current_user.id:
        flash("No tienes permiso para eliminar este gasto", "danger")
        return redirect(url_for("routes.index"))
    if current_user.role != "master" and expense.company_id not in [c.id for c in current_user.companies]:
        flash("Acceso denegado", "danger")
        return redirect(url_for("routes.index"))
    
    try:
        os.remove(os.path.join(current_app.root_path, "static", "uploads", expense.image_path))
    except:
        pass
    
    db.session.delete(expense)
    db.session.commit()
    flash("Gasto eliminado correctamente", "success")
    return redirect(url_for("routes.index"))

# VER IMAGEN
@routes.route('/uploads/<filename>')
def uploads(filename):
    return send_from_directory(os.path.join(current_app.root_path, 'static', 'uploads'), filename)

# RECUPERACIÓN DE CONTRASEÑA
@routes.route('/reset-request', methods=['GET', 'POST'])
def reset_request():
    form = ResetPasswordRequestForm()
    if form.validate_on_submit():
        user = User.query.filter_by(email=form.email.data.lower()).first()
        if user:
            send_reset_password_mail(user)
        flash('Revisa tu correo (o la terminal)', 'info')
        return redirect(url_for('routes.login'))
    return render_template('reset_request.html', form=form)

@routes.route('/reset/<token>', methods=['GET', 'POST'])
def reset_token(token):
    user = User.verify_reset_token(token)
    if not user:
        flash('Enlace inválido o caducado', 'warning')
        return redirect(url_for('routes.login'))
    form = ResetPasswordForm()
    if form.validate_on_submit():
        user.set_password(form.password.data)
        db.session.commit()
        flash('Contraseña cambiada', 'success')
        return redirect(url_for('routes.login'))
    return render_template('reset_password.html', form=form)
